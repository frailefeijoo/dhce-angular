<dhce-mat-expansion-component
  title="Connections"
  summary="Configuración de conexiones de BBDD"
  [expanded]="isPanelExpanded"
  (expandedChange)="onPanelExpandedChange($event)"
>
  <div expansion-header-actions class="connection-active-select" (click)="$event.stopPropagation()">
    <label for="activeConnectionSelect">Conexión activa</label>
    <div class="active-select-with-status">
      <select
        id="activeConnectionSelect"
        [disabled]="!canSelectActiveConnection"
        [value]="activeConnectionName"
        (click)="$event.stopPropagation()"
        (change)="onActiveConnectionChange($any($event.target).value)"
      >
      <option value="">Sin conexión activa</option>
      @for (connection of structuredConnections; track connection.name) {
        <option [value]="connection.name">{{ connection.name }}</option>
      }
      </select>

      <div class="active-connection-status" aria-live="polite">
        <dhce-mat-progress-spinner-component *ngIf="connectionCheckState === 'loading'" [diameter]="18" [strokeWidth]="3"></dhce-mat-progress-spinner-component>

        <span *ngIf="connectionCheckState === 'ok'" class="codicon codicon-check status-icon status-icon-ok" aria-hidden="true"></span>

        <span *ngIf="connectionCheckState === 'error'" class="codicon codicon-error status-icon status-icon-error" aria-hidden="true" [title]="connectionCheckMessage"></span>
      </div>
    </div>
  </div>

  <p>El origen de conexión se determina automáticamente por la extensión del fichero.</p>
  <div class="connection-file-row">
    <div class="connection-file-input">
      <dhce-mat-input
        type="file"
        label="Fichero de conexión"
        [hint]="connectionFileHint"
        [required]="true"
        [validate]="true"
        [businessValid]="connectionFileBusinessValid"
        [businessError]="connectionFileBusinessError"
        [default]="connectionFilePath"
        [pickerResolver]="connectionPickerResolver"
        (valueChange)="onConnectionFileChange($event)"
      ></dhce-mat-input>
    </div>

    <div class="connection-file-status" aria-live="polite">
      @if (isValidatingConnectionFile) {
        <dhce-mat-progress-spinner-component [diameter]="20" [strokeWidth]="3"></dhce-mat-progress-spinner-component>
      } @else if (connectionFileBusinessValid === true) {
        <span class="codicon codicon-check status-icon status-icon-ok" aria-hidden="true"></span>
      } @else if (connectionFileBusinessValid === false && hasConnectionFileValue) {
        <span class="codicon codicon-error status-icon status-icon-error" aria-hidden="true"></span>
      }
    </div>
  </div>

  <dhce-mat-input
    type="string"
    label="Origen de conexión"
    hint="Campo autocalculado según extensión del fichero seleccionado."
    [readonly]="true"
    tabindex="-1"
    [default]="detectedConnectionSourceLabel"
  ></dhce-mat-input>
</dhce-mat-expansion-component>
